<style>
    @import url('https://fonts.googleapis.com/css2?family=Albert+Sans:wght@300;400;500;600;700&family=Space+Mono:wght@400;700&display=swap');
      /* Global Styles */
    body {
      font-family: 'Albert Sans', sans-serif;
      margin: 0px;
      font-size: 14px;
      height: 100%;
    }
    
    /* Heading Styles */
    h4 {
      font-weight: 400;
      font-size: 14px;
    }
    
    /* Container Styles */
    .container {
      display: grid;
      grid-template-columns: 1fr;
      height: calc(100% - 16px);
      transition: 0.2s;
    }
    
    /* Column Styles */
    .column_one, .column_two {
      padding: 0px 14px;
      position: relative;
      display: flex;
      flex-direction: column;
      height: 100%;
      overflow-y: auto;
    }
    
    .column_one {
      padding-bottom: 16px;
      background-color: #F3F3F3;
      position: sticky;
      left: 0;
      z-index: 1;
    }
    
    .column_two {
      z-index: 0;
    }
    
    /* Chip Styles */
    .chip {
      border-radius: 4px;
      padding: 10px 10px;
      cursor: pointer;
      margin-bottom: 4px 0px;
    }
    
    .chip:hover:not(.checked) {
      background-color: #ececec;
    }
    
    .checked {
      background-color: #E2E2E2;
    }
    
    .chip-checkbox, .chip-radio {
      display: none;
    }
    
    .chip-label {
      position: relative;
      padding-left: 22px;
      display: block;
    }
    
    /* Checkmark Styles */
    .checkmark {
      position: absolute;
      top: 50%;
      left: 2px;
      transform: translateY(-50%);
      width: 12px;
      height: 12px;
      border: 2px solid #6A6A6A;
      border-radius: 50%;
      background-color: #fff;
      box-sizing: border-box;
    }
    
    .chip-radio:checked + .chip-label .checkmark {
      background-color: #0981C5;
      border: 4px solid #0981C5;
      box-sizing: border-box;
    }
    
    /* Font Styles */
    .font_styles {
      font-size: 13px;
      margin-top: 8px;
      margin-left: 22px;
      line-height: 1.7;
      color: #616161;
    }
    
    .font-name, .link {
      font-size: 14px;
    }
    
    .font-name {
      margin-bottom: 8px;
      margin-top: 16px;
    }
    
    .font-container {
      margin: 0;
      left: 0;
    }
    
    .font_list {
      padding-top: 108px;
      margin-bottom: 80px;
      overflow-y: auto;
    }
    
    .font_list_c1 {
      overflow-y: scroll;
      padding-bottom: 8px;
      flex-grow: 1;
      margin-bottom: 10px;
    }
    
    .font_context{
      font-size: 13px;
      padding-top: 108px;
      line-height: 1.5;
      display: none;
    }
    
    /* Input Styles */
    .search_input {
      width: 100%;
      border: 1px solid #bfbfbf;
      background-color: #eeeeee8a;
      padding: 8px 12px;
      font-size: 14px;
      border-radius: 4px;
      font-family: 'Albert Sans', sans-serif;
      transition: 0.3s;
      outline: none !important;
    }
    
    .input-container {
      position: relative;
      font-size: 8px;
    }
    
    .material-symbols-rounded {
      font-weight: 600 !important;
      font-display: swap;
      
    }
    .search_icon{
      font-size: 20px !important; 
      color: #afafaf;
      position: absolute;
      top: 50%;
      left: 8px;
      transform: translateY(-50%);
    }
    .rocket_icon{
      font-size: 18px !important; 
      color: #0981C5;
      font-weight: 400 !important;
      animation: jump-shaking 1s;
    }
    
    /* Button Styles */
    .button_container {
      position: fixed;
      right: 0px;
      background-color: #ffffff;
      text-align: center;
      vertical-align: middle;
      padding: 12px 12px;
      border: none;
      color: #fff;
      bottom: 0px;
      width: 244px;
      border-top: 1px solid #eeeeee;
    }
    
    .button {
      background-color: #0981C5;
      text-align: center;
      vertical-align: middle;
      padding: 8px 8px;
      border-radius: 4px;
      color: #fff;
      border: none;
      width: 100%;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    
    .auth_button{
      background-color: #E2E2E2;
      text-align: center;
      vertical-align: middle;
      padding: 8px 8px;
      border-radius: 4px;
      border: none;
      width: 100%;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    
    .button:hover{
      background-color: #084d75;
    }
    
    .fuel_button {
      text-align: center;
      vertical-align: middle;
      display: flex;
      justify-content: start;
      gap: 8px;
      font-weight: 500;
      padding: 6px 8px;
      margin-bottom: 8px;
      border-radius: 4px;
      margin-left: -10px;
      color: #0981C5;
      text-decoration: none;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    
    .fuel_button:hover{
      color: #1b4d69;
    }
    
    /* Header Styles */
    .heading {
      font-weight: 500;
    }
    
    .column_two_header {
      position: fixed;
      width: 244px;
      padding: 0px 12px;
      padding-bottom: 12px;
      border-bottom: 1px solid #eeeeee;
      background-color: #ffffff;
      top: 0;
      right: 0;
      z-index: 2;
    }
    
    /* Note Styles */
    .app_note {
      margin-bottom: -4px;
      font-size: 13px;
      color: #aaaaaa;
      text-align: center;
      transition: opacity 0.5s ease;
    }
    
    /* Progress Styles */
    .progress_indicator {
      height: 100%;
      width: 0px;
      background-color: #0981C5;
    }
    
    #progressContainer {
      width: 100%;
      height: 16px;
      background-color: lightgrey;
      position: relative;
      display: none;
    }
    
    .progress_text {
      font-size: 56px;
    }
    
    .progress-cursor {
      cursor: progress;
    }
    
    @keyframes jump-shaking {
      0% { transform: translateX(0) }
      25% { transform: translateY(-9px) }
      35% { transform: translateY(-9px) rotate(17deg) }
      55% { transform: translateY(-9px) rotate(-17deg) }
      65% { transform: translateY(-9px) rotate(17deg) }
      75% { transform: translateY(-9px) rotate(-17deg) }
      100% { transform: translateY(0) rotate(0) }
    }
    
    .missing_font_icon{
      background-color: #EBC347;
      border-radius: 2px;
      padding: 0px 4px;
      margin-right: 4px;
      font-weight: 400;
      font-family: 'Albert Sans', sans-serif;
    }
    
    .pro_font_icon{
      background-color: #0981C5;
      border-radius: 4px;
      padding: 0px 4px;
      margin-right: 4px;
      font-weight: 300;
      color: #fefefe;
      font-size: 12px;
      font-family: 'Albert Sans', sans-serif;
    }
    
    .no_layer_info{
      margin-top: 40px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      text-align: center;
      align-items: center;
      align-self: center;
    }
    
    .no_font_info{
      margin-top: 40px;
      display: flex;
      flex-direction: column;
      gap: 16px;
      text-align: center;
      align-items: center;
      align-self: center;
    }
    
    h3{
      margin: 0px;
      margin-top: 4px;
      font-size: 14px;
      font-weight: 500;
    }
    
    a:hover{
      color: #084d75;
    }
    
    </style>
    
    <link rel="stylesheet" 
    href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@48,400,1,0&display=swap" />
    
    <div class="container" id="container">
    
      <!-- Column One -->
      <div class="column_one">
    
        <h4 class="heading" id="fonts-found"></h4>
    
        <div id="no-layer-info" class="no_layer_info" style="display: none;">
    
          <img src="https://live.staticflickr.com/65535/53313339433_e385ed6391_o.gif" width="190" height="129" alt="select_layer_2"/>
          <!-- <img src="https://live.staticflickr.com/65535/53312072484_81863de479_o.png" width="190" height="129" alt="select_layer"/> -->
          <script async src="//embedr.flickr.com/assets/client-code.js" charset="utf-8"></script>
          <h3 class="heading" style="color: #268fcb; font-size: 16px;">No layer is selected
          </h3>
          <p style="color: #aaaaaa; margin: 0; margin-bottom: 8px;">Please select any layer to get started</p>
    
          
        </div>
    
    
        <div id="no-font-found" class="no_font_info" style="display: none;">
    
          <img src="https://live.staticflickr.com/65535/53313339433_e385ed6391_o.gif" width="190" height="129" alt="select_layer_2"/>
          <!-- <img src="https://live.staticflickr.com/65535/53312072484_81863de479_o.png" width="190" height="129" alt="select_layer"/> -->
          <script async src="//embedr.flickr.com/assets/client-code.js" charset="utf-8"></script>
          <h3 class="heading" style="color: #268fcb; font-size: 16px; margin-top: 12px;">No font is found
          </h3>
          <p style="color: #aaaaaa; width: 90%; margin-left: auto; margin-right: auto; margin-top: 8px;">Please select more layers to identify fonts</p>
    
          
        </div>
        
        <div id="progressText" class="progress_text"></div>
    
        <div id="progressContainer">
          <div id="progressIndicator" class="progress_indicator"></div>
        </div>
    
        <div id="font-list-c1" class="font_list_c1"></div>
    
        <!-- Hidden Chip -->
        <div class="chip" style="display: none;">
          <input type="radio" id="chip-radio" class="chip-radio">
          <label for="chip-radio" class="chip-label">
            <span class="checkmark"></span>
            <span class="missing_font_icon">A?</span>
            Font Name
          </label>
          <div class="font_styles">Regualr; Medium; SemiBold</div>
        </div>
    
        <!-- Button Container -->
        <!-- <a class="fuel_button" href="https://www.buymeacoffee.com/ux.ashish" target="_blank">
          <span class="material-symbols-rounded rocket_icon">rocket</span>
          <span style="text-decoration: underline; margin-left: -4px;">Fuel my work</span></a> -->
        <!-- Button Container -->
        <button class="auth_button" id="auth-button">Join pro for free</button>
        
        <div id="app-note" class="app_note">
        <!-- Created with ðŸ«¶ by <a href="https://www.linkedin.com/in/ashishsauparna/" target="_blank" style="color:#aaaaaa;">Ashish</a> -->
        </div>
        
      </div>
      
      <!-- Column Two -->
      <div class="column_two" style="display:none;" id="column-two">
        <div class="column_two_header">
          <h4 class="heading">Change to:</h4>
          
          <div class="input-container">
            <input type="search" id="search-input" class="search_input" placeholder="Search here">
          </div>
        </div>
        <div id="font-list" class="font_list"></div>
        <div id="font-context" class="font_context">Showing Font(s) with style</div>
    
        <!-- Button Container -->
        <div class="button_container">
          <button class="button" id="get-frame-details-button">Change Font</button>
        </div>
      </div>
    
    </div>
    
    
    
    <!--------------------------- JavaScript starts from here ----------------------------->
    <script>
    
    // Define and select elements
    const fontListElement = document.getElementById('font-list');
    const button = document.getElementById('get-frame-details-button');
    const authButton = document.getElementById('auth-button');
    const searchInput = document.getElementById('search-input');
    const appNote = document.getElementById('app-note');
    const container = document.getElementById('container');
    const columnTwo = document.getElementById('column-two');
    const noLayerInfo = document.getElementById('no-layer-info');
    const fontsFound = document.getElementById("fonts-found");
    const fontContext = document.getElementById("font-context");
    const noFontLayer = document.getElementById("no-font-found");
    const body = document.body;
    
    // Declare the fontList variable
    let fontList = [];
    let selectedFont = [];
    let newFont = [];
    let styleNames = [];
    let changeFontTo = "";
    let changeFontStyleTo = "";
    let searchQuery = "";
    
    let isSelectedFontChecked = false;
    let isNewFontChecked = false;
    
    button.disabled = true;
    button.style.backgroundColor = "#9EC0D3"
    button.style.cursor = "no-drop";
    
    let index = 0;
    
    noLayerInfo.style.display = "none";
    
    
    //********************************* COLUMN 2 DATA POPULATION *************************************
    
    
    function displayColumnTwo(allFontsInFigma) {
    
      fontListElement.innerHTML = '';
      
      const fontStylesMap = new Map();
    
    
      //Filter Fonts list
      //remove fonts starting with "."
      //remove selected font in column one
    
      allFontsInFigma.forEach((font) => 
        filterFont(font, fontStylesMap));
      
      const filteredFontStylesMap = new Map();
    
      //Filter Font Styles
      //replace some similar fonts styles
    
      fontStylesMap.forEach((fontStyle, FontName) => 
        filteredFontStyles(fontStyle, FontName, filteredFontStylesMap));
    
      filteredFontStylesMap.forEach(([fontStyles, proBox], fontName) => {
        //Creates a chip with matching fonts
        createChipContainer(fontStyles, fontName, proBox);  
      });
    
      updateListOnSearch(allFontsInFigma, filteredFontStylesMap);
    
    }
    
    // ***************** Filter Font Function - Column 2
    
    function filterFont(font, fontStylesMap) {
      //First we get the fontFamily
      const fontName = font.fontName.family;
    
      //Check if the the font style is an array or not
      const fontStyles = Array.isArray(font.fontName.style) ? font.fontName.style : [font.fontName.style];
    
      //If FontName does not start with "."
      if (!fontName.startsWith('.')) {
    
        //if same font name exists remove the font from the list of fonts
        if (!fontStylesMap.has(fontName)) {
          fontStylesMap.set(fontName, []);
        }
    
        //creating an updated fontstyle map with fontName(fontFamily) collected in the start
        const existingFontStyles = fontStylesMap.get(fontName);
    
        fontStyles.forEach((style) => {
    
          //Precaution code to check if the style exisit
          const isStyleExists = existingFontStyles.some((existingStyle) => {
            return existingStyle.style === style;
          });
    
          //Precaution code to check if the style does not exisit
          if (!isStyleExists) {
            existingFontStyles.push({ style: style });
          }
        });
      }
    }
    
    // ***************** Filter Styles Function - Column 2
    
    function filteredFontStyles (fontStyles, fontName, filteredFontStylesMap) {
    
        if (fontName === selectedFont.fontName) return;
    
    
        const formattedSelectedStyles = selectedFont.fontStyles.map((selectedStyle) => 
          selectedStyle.style.toLowerCase()
          .replace(/\s/g, '')
          .replace('oblique', 'italic')
          .replace('book', 'regular')
          .replace('heavy', 'bold')
          .replace('roman', 'regular')
          .replace('basic', 'regular')
          .replace('ultra black', 'black')
          .replace('light bold', 'regular')
        );
    
        let filterFontStyles = fontStyles.filter((fontStyle) => {
          const formattedFontStyle = fontStyle.style.toLowerCase()
          .replace(/\s/g, '')
          return formattedSelectedStyles.includes(formattedFontStyle);
        });
        
    
        let transformedFontStyles = fontStyles.map((fontStyle) => fontStyle.style.toLowerCase().replace(/\s/g, ''));
    
        //console.log(transformedFontStyles)
    
        let desiredOrder = [
          'Thin', 'Thin Italic', 
          'ExtraLight', 'ExtraLightItalic', 'Light', 'LightItalic', 
          'Regular', 'Italic', 'Book', 'Basic', 'Roman', 'BookItalic', 'BasicItalic', 'RomanItalic',
          'Medium', 'MediumItalic', 
          'Semibold','Semi Bold', 'SemiBold', 'SemiBoldItalic', 'Heavy',
          'Bold', 'BoldItalic', 'ExtraBold', 'ExtraBoldItalic', 'heavy',
          'Black', 'BlackItalic'
        ];
    
        filterFontStyles = filterFontStyles.sort(
          (a, b) => {
    
            let indexA = desiredOrder.indexOf(a.style);
            let indexB = desiredOrder.indexOf(b.style);
    
            if (indexA < indexB ) {
              return -1;
            } else if (indexA > indexB) {
              return 1;
            }
            return 0;
          }
        );
    
    
        if(filterFontStyles.length === formattedSelectedStyles.length){
          filteredFontStylesMap.set(fontName, [filterFontStyles, false]);
          //console.log(fontName, filterFontStyles)
        }else{
          let newFontStyle = []
          formattedSelectedStyles.forEach((frStyle, index) => {
    
            if(transformedFontStyles.includes(frStyle)){
              const firstWordCapStyle = frStyle.charAt(0).toUpperCase() + frStyle.slice(1)
              newFontStyle.push(firstWordCapStyle);
    
            }else if(frStyle == "regular" && transformedFontStyles.includes("medium")){
                newFontStyle.push("Medium");
    
            }else if(frStyle == "regular" && transformedFontStyles.includes("roman")){
              newFontStyle.push("Roman");
    
            }else if(frStyle == "medium" && transformedFontStyles.includes("regular")){
              newFontStyle.push("Regular"); 
    
            }else if(frStyle == "semibold" && transformedFontStyles.includes("bold")){
              newFontStyle.push("Bold");  
              
            }else if(frStyle == "bold" && transformedFontStyles.includes("semibold")){
              newFontStyle.push("SemiBold");  
              
            }else if(frStyle == "bold" && transformedFontStyles.includes("black")){
              newFontStyle.push("Black");  
              
            }else if(frStyle == "black" && transformedFontStyles.includes("bold")){
              newFontStyle.push("Bold");  
              
            }else if(frStyle == "ultrablack" && transformedFontStyles.includes("black")){
              newFontStyle.push("Black");  
              
            }
          })
    
          if(newFontStyle.length === formattedSelectedStyles.length){
            let newArrayMap = newFontStyle.map((style, index) => {
              return { style: style };
            });
            filteredFontStylesMap.set(fontName, [newArrayMap, true]);
          }
          
        }
    }
    
    // ***************** Create chipContainer - Column 2
    
    function createChipContainer(fontStyles, fontName, proBox) {
      const chipContainer = document.createElement('div');
      chipContainer.classList.add('chip');
    
      //Create Radio for each chip
      const radio = document.createElement('input');
      radio.type = 'radio';
      radio.name = 'fontSelection';
      radio.id = `chip-radio-${fontName}`;
      radio.classList.add('chip-radio');
    
    
      //Create label for each chip
      const label = document.createElement('label');
      label.htmlFor = `chip-radio-${fontName}`;
      label.classList.add('chip-label');
      label.textContent = fontName;
      label.style.fontFamily = `${fontName}, Albert Sans , sans-serif`;
    
      //Create Checkmark for each Chip
      const checkmark = document.createElement('span');
      checkmark.classList.add('checkmark');
    
      const proFont = document.createElement('span');
      proFont.classList.add('pro_font_icon');
      proFont.textContent = 'Pro';
    
      //Append the Missing font icons
      const foundMissing = fontStyles.map((style) => style.isMissing)
      if(proBox) {label.prepend(proFont)}
      
    
      //Create style reference subText for each Chip
      const fontStylesElement = document.createElement('div');
      fontStylesElement.classList.add('font_styles');
      const styleNames = fontStyles.map((style) => style.style);
      fontStylesElement.textContent = styleNames.join('; ');
    
      //Append all to a container "chipContainer"
      label.appendChild(checkmark);
      chipContainer.appendChild(radio);
      chipContainer.appendChild(label);
      chipContainer.appendChild(fontStylesElement);
    
      //Append the "chipContainer" to "fontListElement" aka font-list of column 2
      fontListElement.appendChild(chipContainer);
      
      addEventListenerToChipContainer(chipContainer, radio, styleNames, fontName);
    
    }
    
    // ***************** On chip click event - Column 2
    
    function addEventListenerToChipContainer(chipContainer, radio, styleNames, fontName) {
      
      chipContainer.addEventListener('click', function () {
    
        if (radio.checked) return;
    
        radio.checked = true;
        isNewFontChecked = true;
    
        if(isSelectedFontChecked && isNewFontChecked){
          button.disabled = false;
          button.style.backgroundColor = "#0981C5";
          button.style.cursor = "pointer";
        }
    
        newFont = {
          fontName: fontName,
          fontStyles: styleNames
        };
      
        console.log('Selected New Font Name:', newFont.fontName);
        console.log('Selected New Font Styles:', newFont.fontStyles);
    
        const allChipContainers = fontListElement.querySelectorAll('.chip');
        allChipContainers.forEach((container) => {
          container.classList.remove('checked');
        });
    
        chipContainer.classList.add('checked');
      });
    }
    
    // ***************** Search Input - Column 2
    
    searchInput.addEventListener('input', (event) => {
      searchQuery = event.target.value;
      parent.postMessage({ pluginMessage: { query: "getQuery", foundQuery: searchQuery}, pluginId: "1246737736127570810" }, "*");
    });
    
    // ***************** Update on Search - Column 2
    
    function updateListOnSearch(allFontsInFigma, filteredFontStylesMap) {
    
    // ---- Code to test if font search exist in the list of fonts available
    
    const regex = new RegExp(`\\b${searchQuery.toLowerCase()}\\b`, 'i');
    
    let allFontNames = allFontsInFigma.map((font) => {
      font.fontName.family.toLowerCase()
    });
    
    const wholeWordMatches = allFontNames.filter((allFontNames) => regex.test(allFontNames));
    
    
    // ---- Informing user that the font do-not exist
    
    if(wholeWordMatches.length === 0 && filteredFontStylesMap.size === 0){
      fontContext.style.display = "block";
      fontListElement.style.display = "none";
      fontContext.innerHTML = `<span style="color:#616161; padding-left:4px;">No match found for</span>
      <span style="color:#616161; font-weight:600;">"${searchQuery}".</span> 
      </br> </br>
      <div style="background:#F6F6F6;border-radius:6px; padding:8px 12px;">
        <span style="color:#5A5A5A;">The font is either unavailable or does not match styles:
          <span style="font-weight:400;">${selectedFont.fontStyles.map((fontStyle) => fontStyle.style).join("; ")}</span>
        </span>
        </br></br>
        <a style="color:#0981C5; text-decoration:underline; cursor:pointer;" 
          href="https://www.google.com/search?client=safari&rls=en&q=download+${searchQuery}+font&ie=UTF-8&oe=UTF-8" 
          target="_blank"> Search for ${searchQuery} on Google?</a>
      </div>`;
    }
    
    // ---- Informing user that the font exists but style is not available
    
    else if(wholeWordMatches.length >=1 && filteredFontStylesMap.size === 0){
      fontContext.style.display = "block";
      fontListElement.style.display = "none";
      fontContext.innerHTML = `<span style="color:#616161; padding-left:4px;">No match found for</span>
      <span style="color:#616161; font-weight:600;">"${searchQuery}".</span> 
      </br> </br>
      <div style="background:#F6F6F6;border-radius:6px; padding:8px 12px;">
        <span style="color:#5A5A5A;">The font is either unavailable or does not match styles:
          <span style="font-weight:400;">${selectedFont.fontStyles.map((fontStyle) => fontStyle.style).join("; ")}</span>
        </span>
        </br></br>
        <a style="color:#0981C5; text-decoration:underline; cursor:pointer;" 
          href="https://www.google.com/search?client=safari&rls=en&q=download+${searchQuery}+font&ie=UTF-8&oe=UTF-8" 
          target="_blank"> Search for ${searchQuery} on Google?</a>
      </div>`;
    }
    
    
    // ---- If everything is fine then show the list of fonts
    
    else{
      fontListElement.style.display = "block";
      fontContext.style.display = "none";
    }
    }
    
    
    
    
    
    
    //********************************* COLUMN 1 & OTHER DATA POPULATION ***************************************
    
    
    window.onmessage = (event) => {
    
      // ***************** COLUMN 1 DATA POPULATION
      if (event.data.pluginMessage && event.data.pluginMessage.type === "fontList") {
        showSelectionResult(event);
      } else if (event.data.pluginMessage && event.data.pluginMessage.type === "largeFontList") {
        const largeFontList = event.data.pluginMessage.fonts;
        displayColumnTwo(largeFontList);
      } else if (event.data.pluginMessage && event.data.pluginMessage.type === "showProgress") {
        showProgress(event);
      } else if (event.data.pluginMessage && event.data.pluginMessage.type === "hideProgress") {
        onProgressComplete(event);
      } else {
        showNothing(event);
      }
    
    };
    
    
    function showNothing(event) {
    
      console.log(event.data.pluginMessage.type);
      
      noLayerInfo.style.display = "flex";
      fontsFound.style.display = "none";
      noFontLayer.style.display = "none";
    
      const fontListElementOld = document.getElementById("font-list-c1");
      const linkElement = document.getElementById("link");
      const progressElement = document.getElementById("progressIndicator");
      const progressText = document.getElementById("progressText");
      const progressContainer = document.getElementById("progressContainer");
      progressContainer.style.display = "none";
      progressElement.style.width = "0px";
      progressText.textContent = "";
    
      fontListElementOld.innerHTML = "";
      columnTwo.style.display = "none";
      container.style.gridTemplateColumns = "1fr";
    
      button.disabled = true;
      button.style.backgroundColor = "#9EC0D3";
      button.style.cursor = "no-drop";
    
      isNewFontChecked = false;
      isSelectedFontChecked = false;
    
      body.classList.remove("progress-cursor");
    }
    
    
    function showSelectionResult(event){
    
      const frameFontList = event.data.pluginMessage.fonts;
      const fontListElementOld = document.getElementById("font-list-c1");
    
      fontsFound.style.display = "block";
      noLayerInfo.style.display = "none";
    
      columnTwo.style.display = "none";
      container.style.gridTemplateColumns = "1fr";
    
      fontListElementOld.innerHTML = "";
      button.disabled = true;
      button.style.backgroundColor = "#9EC0D3";
      // appNote.innerHTML = `Created with ðŸ«¶ by 
      //   <a href="https://www.linkedin.com/in/ashishsauparna/" target="_blank" style="color:#aaaaaa;">Ashish</a>`
      
      const fontStylesMap = new Map(); // Map to store font styles by font name
    
    
      frameFontList.forEach((font) => {
        const fontName = font.family;
        const fontStyles = font.styles;
    
        if (!fontStylesMap.has(fontName)) {
          fontStylesMap.set(fontName, []);
        }
    
        const existingFontStyles = fontStylesMap.get(fontName);
        fontStyles.forEach((style) => {
          // Check if the font style already exists for the font family
          const isStyleExists = existingFontStyles.some((existingStyle) => {
            return existingStyle.style === style.style;
          });
    
          // Add the font style if it doesn't already exist
          if (!isStyleExists) {
            existingFontStyles.push(style);
          } 
        });
      });
    
        const fontNames = Array.from(fontStylesMap.keys());
        
        if(fontNames.length > 1){
    
          fontsFound.textContent = `${fontNames.length} fonts are found`;
          fontsFound.style.display = "block";
          noFontLayer.style.display = "none";
    
        }else if(fontNames.length === 0){
    
          noFontLayer.style.display = "block";
          fontsFound.style.display = "none";
    
        }
        else{
    
          fontsFound.textContent = `${fontNames.length} font is found`;
          fontsFound.style.display = "block";
          noFontLayer.style.display = "none";
    
        }
    
        fontNames.forEach((fontName) => {
    
          let fontStyles = fontStylesMap.get(fontName);
    
          // Define the order of font styles
          const desiredOrder = [
            'Thin', 'Thin Italic', 
            'ExtraLight', 'ExtraLightItalic', 'Light', 'LightItalic', 
            'Regular', 'Italic', 'Book', 'Basic', 'Roman', 'BookItalic', 'BasicItalic', 'RomanItalic',
            'Medium', 'MediumItalic', 
            'SemiBold', 'SemiBoldItalic', 'Heavy',
            'Bold', 'BoldItalic', 'ExtraBold', 'ExtraBoldItalic', 'heavy',
            'Black', 'BlackItalic'];
    
          // Sort the fontStyles array according to the fontStyleOrder
          fontStyles = fontStyles.sort((a, b) => {
    
            let indexA = desiredOrder.indexOf(a.style);
            let indexB = desiredOrder.indexOf(b.style);
    
            if (indexA < indexB ) {
              return -1;
            } else if (indexA > indexB) {
              return 1;
            }
            return 0;
    
          });
    
          // Create the chip container
          const chipContainer = document.createElement("div");
          chipContainer.classList.add("chip");
    
          // Create the radio button
          const radio = document.createElement("input");
          radio.type = "radio";
          radio.name = "fontSelectionFigma"; // Set the same name for all radio buttons to make them mutually exclusive
          radio.id = `chip-radio2-${fontName}`;
          radio.classList.add("chip-radio");
    
          //Create a call for the font
          // const linkElement = document.createElement('link');
          // const callGoogleFont = fontName.replace(/\s+/g, '+');
    
          addStylesheetLink(fontName);
    
          // addStylesheetLink(`https://fonts.googleapis.com/css?family=${callGoogleFont}&display=swap`);
    
          // Create the label for the radio button
          const label = document.createElement("label");
          label.htmlFor = `chip-radio-${fontName}`;
          label.classList.add("chip-label");
    
          label.textContent = fontName;
          // Remove dot from the beginning of the fontName
          const withoutDotFontName = fontName.replace(/^\./, "");
    
          // Set the font family for the label element
          label.style.fontFamily = `"${withoutDotFontName}", Albert Sans , sans-serif`;
    
          console.log(`Font Family for ${fontName}: ${label.style.fontFamily}`);
    
          // Create the checkmark span
          const checkmark = document.createElement("span");
          checkmark.classList.add("checkmark");
    
    
          const missingFont = document.createElement('span');
          missingFont.classList.add('missing_font_icon');
          missingFont.textContent = 'A?';
    
          // Append the checkmark to the label
          label.appendChild(checkmark);
          //Append the Missing font icons
          const foundMissing = fontStyles.map((style) => style.isMissing)
          if(foundMissing[0]) {label.prepend(missingFont)}
          // Append the radio button and label to the chip container
          chipContainer.appendChild(radio);
          chipContainer.appendChild(label);
    
          // Create the font styles element
          const fontStylesElement = document.createElement("div");
          fontStylesElement.classList.add("font_styles");
    
          styleNames = fontStyles.map((style) => style.style);
          const allSelectedStyleNames = styleNames.join("; ");
          fontStylesElement.textContent = allSelectedStyleNames;
    
          // Append the font styles element to the chip container
          chipContainer.appendChild(fontStylesElement);
    
          // Add event listener to the chip container
          chipContainer.addEventListener("click", function () {
            // Check if the radio button is already checked
            if (radio.checked) {
              return;
            }
    
            // Check the radio button
            radio.checked = true;
    
            isSelectedFontChecked = true;
    
            if (isSelectedFontChecked) {
              button.disabled = true;
              button.style.backgroundColor = "#9EC0D3";
              button.style.cursor = "no-drop";
            }
    
            // Update the selected font variable with the font details
            selectedFont = {
              fontName: fontName,
              fontStyles: fontStyles,
            };
    
            // Access the selected font details for further use within the page
            console.log("Selected Font Name:", selectedFont.fontName);
            console.log("Selected Font Styles:", selectedFont.fontStyles);
    
            // Remove the 'checked' class from all chip containers
            const allChipContainers = fontListElementOld.querySelectorAll(".chip");
            allChipContainers.forEach((container) => {
              container.classList.remove("checked");
              parent.postMessage({ pluginMessage: { query: "getQuery", foundQuery: searchInput.value }, pluginId: "1246737736127570810"  }, "*");
            });
    
            // Add the 'checked' class to the current chip container
            chipContainer.classList.add("checked");
    
            setTimeout(function () {
              columnTwo.style.display = "block";
              container.style.gridTemplateColumns = "1fr 1.1fr";
            }, 200);
          });
    
          // Append the chip container to the fontListElement
          fontListElementOld.appendChild(chipContainer);
        });
    }
    
    
    function showProgress(event){
    
      const percentage = event.data.pluginMessage && event.data.pluginMessage.progress;
      const progressElement = document.getElementById("progressIndicator");
      const progressContainer = document.getElementById("progressContainer");
      progressContainer.style.display = "block";
      progressElement.style.width = `${percentage}%`;
    
      const progressText = document.getElementById("progressText");
      progressText.textContent = `${percentage}%`;
    
      appNote.innerHTML =
        "Updating fonts can take a minute, depending upon the selection size. \
        Avoid selecting other elements during the update. Thank you for your patience.";
      const fontListElementOld = document.getElementById("font-list-c1");
      const linkElement = document.getElementById("link");
    
      fontListElementOld.innerHTML = "";
      fontsFound.textContent = "Changing fonts, please wait...";
    
      columnTwo.style.display = "none";
      container.style.gridTemplateColumns = "1fr";
    
      button.disabled = true;
      button.style.backgroundColor = "#9EC0D3";
      button.style.cursor = "no-drop";
    
      isNewFontChecked = false;
      isSelectedFontChecked = false;
    
    }
    
    function onProgressComplete(event){
    
      fontsFound.style.display = "block";
    
      fontsFound.textContent = "Change Successfull!";
    
      const fontListElementOld = document.getElementById("font-list-c1");
      const linkElement = document.getElementById("link");
    
      fontListElementOld.innerHTML = "";
    
      columnTwo.style.display = "none";
      container.style.gridTemplateColumns = "1fr";
    
      button.disabled = true;
      button.style.backgroundColor = "#9EC0D3";
    
      isNewFontChecked = false;
      isSelectedFontChecked = false;
    
      body.classList.remove("progress-cursor");
    
      appNote.innerHTML = "";

      // appNote.innerHTML = `<div style="margin-bottom:4px;"> Thank you fo using Font Swap :) </div> 
      // <a href="https://www.linkedin.com/in/ashishsauparna/" target="_blank" style="color:#0981C5;">Say hi on LinkedIn</a>`

      parent.postMessage({ pluginMessage: { success: true } }, "*");
    }
    
    
    
    // Send the "getFonts" message to the parent context
    parent.postMessage({ pluginMessage: { type: "getFonts" }, pluginId: "1246737736127570810"  }, "*");
    
    
    
    // Add a click event listener to the button
    button.addEventListener('click', function () {
      //console.log(selectedFont)
      if(isSelectedFontChecked & isNewFontChecked){
        parent.postMessage({ pluginMessage: { name: "changeFont", selectedFont: selectedFont, newFont: newFont }, pluginId: "1246737736127570810"  }, '*');
        body.classList.add("progress-cursor");
      }else{
        console.error("Your internet is not working!")
      }
    });
    
    
    // Create a function to add a stylesheet link
    function addStylesheetLink(href) {
    
      // Fetch the list of Google Fonts
      fetch(`https://www.googleapis.com/webfonts/v1/webfonts?key=AIzaSyCvD0oiBjCLhewwxak9mGyp2AHqmgWooXM`)
      .then(response => response.json())
      .then(data => {
        // Check if the desired font is in the list
        const fontExists = data.items.some(font => font.family === href);
    
        if (fontExists) {
          const linkElement = document.createElement('link');
          // Set attributes for the link element
          linkElement.rel = 'stylesheet';
          linkElement.href = `https://fonts.googleapis.com/css?family=${href}&display=swap`;
          document.head.appendChild(linkElement);
          console.log(`${href} is available on Google Fonts.`);
    
          
        } else {
          console.error(`${href} is not available on Google Fonts.`);
        }
      })
      .catch(error => console.error('Error fetching Google Fonts:', error));
    }

  authButton.addEventListener("click", function(){
    window.open(trySampleRequest(), "_blank")
  })

  var YOUR_CLIENT_ID = '224939236194-tp92u16rbrnce5i9mpon56sah9otslbu.apps.googleusercontent.com';
  var YOUR_REDIRECT_URI = 'https://www.ashishsauparna.in/index.html';
  var fragmentString = location.hash.substring(1);

  // Parse query string to see if page request is coming from OAuth 2.0 server.
  var params = {};
  var regex = /([^&=]+)=([^&]*)/g, m;
  while (m = regex.exec(fragmentString)) {
    params[decodeURIComponent(m[1])] = decodeURIComponent(m[2]);
  }
  if (Object.keys(params).length > 0) {
    localStorage.setItem('oauth2-test-params', JSON.stringify(params) );
    if (params['state'] && params['state'] == 'try_sample_request') {
      trySampleRequest();
    }
  }

  // If there's an access token, try an API request.
  // Otherwise, start OAuth 2.0 flow.
  function trySampleRequest() {
    var params = JSON.parse(localStorage.getItem('oauth2-test-params'));
    if (params && params['access_token']) {
      var xhr = new XMLHttpRequest();
      xhr.open('GET',
          'https://openidconnect.googleapis.com/v1/userinfo?' +
          'access_token=' + params['access_token']);
      xhr.onreadystatechange = function (e) {
        if (xhr.readyState === 4 && xhr.status === 200) {
          console.log(xhr.response);
        } else if (xhr.readyState === 4 && xhr.status === 401) {
          // Token invalid, so prompt for user permission.
          oauth2SignIn();
        }
      };
      xhr.send(null);
    } else {
      oauth2SignIn();
    }
  }

  /*
   * Create form to request access token from Google's OAuth 2.0 server.
   */
  function oauth2SignIn() {
    // Google's OAuth 2.0 endpoint for requesting an access token
    var oauth2Endpoint = 'https://accounts.google.com/o/oauth2/v2/auth';

    // Create element to open OAuth 2.0 endpoint in new window.
    var form = document.createElement('form');
    form.setAttribute('method', 'GET'); // Send as a GET request.
    form.setAttribute('action', oauth2Endpoint);

    // Parameters to pass to OAuth 2.0 endpoint.
    var params = {'client_id': YOUR_CLIENT_ID,
                  'redirect_uri': YOUR_REDIRECT_URI,
                  'scope': 'openid profile email',
                  'state': 'try_sample_request',
                  'include_granted_scopes': 'true',
                  'response_type': 'token'};

    // Add form parameters as hidden input values.
    for (var p in params) {
      var input = document.createElement('input');
      input.setAttribute('type', 'hidden');
      input.setAttribute('name', p);
      input.setAttribute('value', params[p]);
      form.appendChild(input);
    }

    // Add form to page and submit it to open the OAuth 2.0 endpoint.
    document.body.appendChild(form);
    form.submit();
  }
    
    </script>
    